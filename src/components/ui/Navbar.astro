---
import { Image } from 'astro:assets'
import {profile} from '../../settings'
import SocialIcons from './SocialIcons.astro'
import MyIcon from '@/assets/Me.jpeg'
import { getCollection } from 'astro:content'
import { template } from '@/settings'

// Load all posts that are publishable (both zh/en), excluding drafts.
// Supports both `publishedAt` (new) and `date` (legacy).
const blogCollection = await getCollection('blog', ({ data }) => {
	if (data.draft) return false
	return true
})

const isBlogPopulated = blogCollection.length > 0

const hasZhPosts = blogCollection.some(({ id, data }) => (data.lang ?? (id.startsWith('zh/') ? 'zh' : id.startsWith('en/') ? 'en' : undefined)) === 'zh')
const hasEnPosts = blogCollection.some(({ id, data }) => (data.lang ?? (id.startsWith('zh/') ? 'zh' : id.startsWith('en/') ? 'en' : undefined)) === 'en')

// Default: land on category picker
const blogHref = `${template.base}/blog`

const hasRecentBlogPost = (() => {
	const now = new Date()
	const recentThresholdMs = 7 * 24 * 60 * 60 * 1000

	// Find the most recent published post (ignoring invalid or future dates).
	const latestPublished = blogCollection.reduce<Date | null>((latest, { data }) => {
		const published = new Date((data as any).publishedAt ?? (data as any).date)
		const isValid = !Number.isNaN(published.getTime())
		const isInPast = published.getTime() <= now.getTime()

		if (!isValid || !isInPast) return latest
		if (!latest || published.getTime() > latest.getTime()) return published
		return latest
	}, null)

	if (!latestPublished) return false

	const timeSinceLatest = now.getTime() - latestPublished.getTime()
	return timeSinceLatest <= recentThresholdMs
})()

const {fullName, title_name} = profile
---
<aside
	class='px-4 pt-4 h-screen w-[20rem] bg-base-200 text-base-content flex flex-col'
>
	<div class='flex flex-col my-8 justify-between h-full'>
		<div>
					<div class="flex justify-center items-center flex-col">
					<div class="mask mask-circle size-44 overflow-hidden">
						<Image
						src={MyIcon}
						alt={`Profile picture of ${fullName}`}
						class="object-cover w-full h-full"
						/>
					</div>
				<h1 class="text-lg font-black mt-8 hidden lg:block">{title_name} {fullName}</h1>
			</div>
			<div class='mx-4 mt-16'>
				<ul class='space-y-4 menu grow shrink menu-md overflow-y-auto'>
					<li>
                        <a href={`${template.base}/`} class='text-lg'>Home</a>
					</li>
					<li>
                        <a href={`${template.base}/research`} class='text-lg'>Research</a>
					</li>
					<li>
                        <a href={`${template.base}/papers`} class='text-lg'>Papers</a>
					</li>
					<li>
                        <a href={`${template.base}/cv`} class='text-lg'>CV</a>
                    </li>
					<li>
                        <a href={`${template.base}/soilsurvey`} class='text-lg'>Soil Survey</a>
                    </li>
					<li>
                        <a href={`${template.base}/academicactivity`} class='text-lg'>Academic Activity</a>
                    </li>
					{isBlogPopulated && (
					<li>
						<a href={blogHref} class='text-lg flex items-center justify-between'>
							<span>Blog</span>
							{hasRecentBlogPost && (
								<span class="ml-2 px-2 py-0.5 text-xs bg-red-500 text-white rounded-full animate-pulse">
									NEW
								</span>
							)}
						</a>
					</li>
					)}
			</ul>
			</div>
		</div>
		<div class='mx-4'>
			<SocialIcons/>
		</div>
	</div>
</aside>
