---
import { isSoilsurvey } from '@/types/soilsurvey';
import type { Soilsurvey } from '@/types/soilsurvey';

interface Props {
	elements: (Soilsurvey)[]
	colored: boolean
}

const { elements, colored } = Astro.props;

// 依時間從新到舊排序（假設 element.time 是可以被 Date() 解析的字串，如 "2025-11-01" 或 "2025-11"）
const sortedElements = [...elements].sort((a, b) => {
  const ta = new Date(a.time).getTime();
  const tb = new Date(b.time).getTime();
  return tb - ta; // 新的（時間比較大）排在前面
});
---

<ul
  class='timeline timeline-snap-icon max-md:timeline-compact timeline-vertical'
>
  {
    sortedElements.map((element, index) => (
      <li>
				<div class='timeline-middle'>
					<svg
						xmlns='http://www.w3.org/2000/svg'
						viewBox='0 0 20 20'
						fill='currentColor'
            class:list={[{ 'text-accent': colored }, 'h-5 w-5']}
					>
						<path
							fill-rule='evenodd'
							d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z'
							clip-rule='evenodd'
						/>
					</svg>
				</div>
				<div
					class={`${index % 2 === 0 ? 'timeline-start' : 'timeline-end'} mb-10 md:text-end`}
				>
					<time class='font-mono italic'>{element.time}</time>
					<div class='text-lg font-black'>{isSoilsurvey(element) ? element.soilclassification : element}</div>
					<div>{element.description}</div>
          					<div>{isSoilsurvey(element) ? element.location : element}
                    </div>
                    {isSoilsurvey(element) && element.image && (
                    <img
                    src={element.image}
                    alt={element.soilclassification}
                    class="mt-3 w-64 object-cover rounded-xl shadow-md mx-auto"
                    loading="lazy"
                    />
                     )}

					 {/** ✅ 新增：detail 區塊（可折疊） */}
  {element.detail && (
  <details class="mt-4 group">
    <summary class="cursor-pointer select-none font-semibold flex items-center gap-2 justify-end text-right">
      {element.detail.subtitle || 'Details'}
      <span class="i-lucide-chevron-down transition-transform group-open:rotate-180"></span>
    </summary>

    {element.detail.text && (
      <p class="mt-2 leading-relaxed text-right text-justify">
        {element.detail.text}
      </p>
    )}

    {/** ✅ 相簿樣式：固定比例、裁切成方形、可點擊放大 */}
    {element.detail.subimages && element.detail.subimages.length > 0 && (
      <div class="mt-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 justify-items-end">
        {element.detail.subimages.map((img, i) => (
          <a
            href={img}
            target="_blank"
            rel="noopener"
            class="block group"
          >
            <div class="w-full aspect-square overflow-hidden rounded-lg">
              <img
                src={img}
                alt={`${element.location} detail ${i + 1}`}
                class="h-full w-full object-cover transition-transform duration-200 group-hover:scale-105"
                loading="lazy"
                width="600"
                height="600"
              />
            </div>
          </a>
        ))}
      </div>
    )}
  </details>
)}
        </div>
        <hr class:list={[{ 'bg-accent': colored }]} />
			</li>
		))
	}
</ul>
