---
import Layout from '@/layouts/Layout.astro'
import { template } from '@/settings'
import { getCollection } from 'astro:content'

const blogEntries = await getCollection('blog')

const buildCategoryList = (lang: 'zh' | 'en') => {
	const counts = new Map<string, number>()
	blogEntries
		.filter(post => post.data.lang === lang)
		.forEach(post => {
			const name = post.data.category
			counts.set(name, (counts.get(name) ?? 0) + 1)
		})

		return Array.from(counts.entries())
			.map(([name, count]) => ({
				name,
				slug: name,
				count,
				href: `${template.base}/blog/category/${name}/1`,
			}))
		.sort((a, b) => b.count - a.count || a.name.localeCompare(b.name))
}

const zhCategories = buildCategoryList('zh')
const enCategories = buildCategoryList('en')
---

<Layout title='Blog Categories'>
	<section class='mx-auto w-full max-w-5xl px-6 lg:px-0 space-y-10'>
		<header class='space-y-3'>
			<p class='text-sm font-semibold uppercase tracking-[0.08em] text-accent'>Blog</p>
			<h1 class='text-3xl font-bold text-base-content'>Browse by category</h1>
			<p class='text-base text-base-content/70'>
				先挑選分類，再進入文章列表。分類含中文與英文各自的文章。
			</p>
		</header>

		<div class='grid gap-8'>
			<section class='space-y-4'>
				<div class='flex items-center gap-2'>
					<span class='text-lg font-semibold'>中文分類</span>
					<span class='badge badge-outline'>{zhCategories.length}</span>
				</div>
				<div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4'>
					{
						zhCategories.length > 0 ? (
							zhCategories.map(cat => (
								<a
									href={cat.href}
									class='card bg-base-200 border border-base-300 hover:border-accent transition-colors'
								>
									<div class='card-body'>
										<div class='flex items-center justify-between'>
											<h2 class='card-title text-base-content'>{cat.name}</h2>
											<span class='badge badge-accent badge-outline'>{cat.count}</span>
										</div>
										<p class='text-sm text-base-content/70'>中文文章</p>
									</div>
								</a>
							))
						) : (
							<p class='text-base-content/60'>目前尚無中文分類。</p>
						)
					}
				</div>
			</section>

			<section class='space-y-4'>
				<div class='flex items-center gap-2'>
					<span class='text-lg font-semibold'>English categories</span>
					<span class='badge badge-outline'>{enCategories.length}</span>
				</div>
				<div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4'>
					{
						enCategories.length > 0 ? (
							enCategories.map(cat => (
								<a
									href={cat.href}
									class='card bg-base-200 border border-base-300 hover:border-accent transition-colors'
								>
									<div class='card-body'>
										<div class='flex items-center justify-between'>
											<h2 class='card-title text-base-content'>{cat.name}</h2>
											<span class='badge badge-accent badge-outline'>{cat.count}</span>
										</div>
										<p class='text-sm text-base-content/70'>English posts</p>
									</div>
								</a>
							))
						) : (
							<p class='text-base-content/60'>No English categories yet.</p>
						)
					}
				</div>
			</section>
		</div>
	</section>
</Layout>
