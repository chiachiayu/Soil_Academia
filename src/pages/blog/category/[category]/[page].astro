---
import Pagination from '@/components/ui/Pagination.astro'
import Layout from '@/layouts/Layout.astro'
import { trimExcerpt } from '@/lib/utils'
import { template } from '@/settings'
import { getCollection } from 'astro:content'

export async function getStaticPaths({ paginate }) {
	const blogEntries = await getCollection('blog')

	const posts = blogEntries
		.map(post => ({
			title: post.data.title,
			description: post.data.description,
			publishedAt: post.data.publishedAt,
			badge: post.data.tags[0],
			excerpt: trimExcerpt(post.data.description),
			slug: `${template.base}/blog/${post.id}`,
			category: post.data.category,
		}))
		.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime())

	const categories = Array.from(new Set(posts.map(post => post.category)))

	return categories.flatMap(category =>
		paginate(posts.filter(post => post.category === category), {
			pageSize: template.postPerPage,
			params: { category },
		}),
	)
}

const { page } = Astro.props
const categoryParam = decodeURIComponent(Astro.params.category)
---

<Layout title={`Category: ${categoryParam}`}>
	<div>
		<div class='flex flex-wrap items-center justify-between gap-2 mb-6'>
			<h1 class='text-3xl font-bold'>
				分類：<span class='text-accent'>{categoryParam}</span>
			</h1>
			<a
				class='btn btn-sm btn-outline'
				href={`${template.base}/blog`}
			>
				回到分類
			</a>
		</div>

		<div class='grid gap-8'>
			{
				page.data.map(post => (
					<article class='card bg-base-200 transition-all'>
						<div class='card-body'>
							<div class='flex justify-between items-start'>
								<h2 class='card-title text-xl'>
									<a href={post.slug} class='hover:text-accent'>
										{post.title}
									</a>
								</h2>
								{post.badge && (
									<div class='badge badge-accent badge-outline p-4'>
										{post.badge}
									</div>
								)}
							</div>
							<time datetime={post.publishedAt} class='text-sm text-base-content/71'>
								{new Date(post.publishedAt).toLocaleDateString('en-US', {
									year: 'numeric',
									month: 'long',
									day: 'numeric',
								})}
							</time>
							<p class='mt-4'>{post.excerpt}</p>
							<div class='card-actions justify-end'>
								<a
									href={post.slug}
									class='btn btn-sm btn-secondary text-secondary-content'
								>
									Read More
								</a>
							</div>
						</div>
					</article>
				))
			}
		</div>

		<div class='flex justify-center mt-8'>
			<Pagination page={page} />
		</div>
	</div>
</Layout>
